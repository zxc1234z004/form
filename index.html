<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å´‡æ­£ç­æœŸé»åç³»çµ±</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background-color: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h3 { text-align: center; color: #444; margin-bottom: 20px; }
    
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .area-btn { 
      background-color: #2196F3; color: white; border: none; padding: 18px; 
      border-radius: 10px; font-size: 1.05em; cursor: pointer; font-weight: bold; 
      transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;
    }
    .area-btn:hover { background-color: #1976D2; transform: translateY(-2px); }
    .area-btn::after { content: 'â†’'; opacity: 0.7; }
    
    .search-btn {
      background-color: #673AB7; color: white; border: none; padding: 15px;
      border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: bold;
      width: 100%; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 8px;
    }
    .search-btn:hover { background-color: #512DA8; }

    .sub-area-btn { background-color: #607D8B; }

    .row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 15px 0; }
    .info { display: flex; flex-direction: column; }
    .name-text { font-size: 1.1em; font-weight: bold; }
    .sub-text { font-size: 0.85em; color: #666; }
    
    .btn-group { display: flex; gap: 8px; }
    button { border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
    .btn-present { background-color: #4caf50; color: white; }
    .btn-leave { background-color: #ff9800; color: white; }
    
    .back-btn { background-color: #757575; color: white; margin-bottom: 15px; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
    .hidden { display: none !important; }
    
    #loader { text-align: center; color: #666; padding: 20px; font-size: 0.9em; }

    /* ç¼ºå¸­åå–®å°ˆç”¨æ ¼å¼ */
    .absent-row { padding: 16px 12px; border-bottom: 1px solid #eee; background: #fff; }
    .absent-name { font-size: 1.25em; font-weight: 800; color: #d32f2f; margin-bottom: 10px; }
    .absent-detail-line { display: flex; gap: 20px; font-size: 1em; color: #444; margin-bottom: 6px; }
    .absent-label { color: #888; margin-right: 6px; font-weight: normal; font-size: 0.9em; }
    .absent-val { font-weight: 600; }
    .reason-text { color: #f57c00; font-weight: 700; }

    /* Modal æ¨£å¼ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; 
      z-index: 9999; backdrop-filter: blur(2px);
    }
    .modal-card {
      background: white; padding: 24px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-card h4 { margin: 0 0 8px 0; color: #333; }
    .modal-card select, .modal-card input {
      width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 1.1em; box-sizing: border-box;
    }
    .modal-actions { display: flex; gap: 12px; }
    .modal-actions button { flex: 1; padding: 12px; }
    .btn-cancel { background: #f0f0f0; color: #444; }
    .btn-confirm { background: #ff9800; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h3 id="title">ğŸ“‹ é»åç³»çµ±</h3>
    
    <div id="main-actions">
      <button id="search-absent-btn" class="search-btn hidden" onclick="loadAndShowAbsentList()">ğŸ” æŸ¥çœ‹ä»Šæ—¥ç¼ºå¸­åå†Š (ç´”é¡¯ç¤º)</button>
    </div>

    <button id="back-btn" class="back-btn hidden">â† è¿”å›</button>
    <div id="loader">è¼‰å…¥ä¸­...</div>
    <div id="area-grid" class="grid hidden"></div>
    <div id="sub-area-grid" class="grid hidden"></div>
    <div id="name-list" class="hidden"></div>
  </div>

  <div id="leave-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <h4 id="modal-title-name">è«‹å‡ç™»è¨˜</h4>
      <p>è«‹é¸æ“‡åŸå› ï¼š</p>
      <select id="leave-reason" onchange="toggleOtherInput()">
        <option value="ç—…å‡">ç—…å‡</option>
        <option value="äº‹å‡">äº‹å‡</option>
        <option value="å…¬å‡">å…¬å‡</option>
        <option value="æ™šåˆ°">æ™šåˆ°</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <input type="text" id="other-reason" class="hidden" placeholder="è«‹è¼¸å…¥è«‹å‡åŸå› ...">
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeLeaveModal()">å–æ¶ˆ</button>
        <button class="btn-confirm" id="confirm-leave-btn">ç¢ºèªæäº¤</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxNFakNmcRc37HVkTyl3qmX4ovQ4REekrYTnHI7jbxW6LWO2uEoPaqP8Ok57lLtPT6J/exec";
    let allData = []; 
    let currentTargetItem = null;
    let currentTargetBtn = null;

    const AREA_GROUPS = [
      { name: "ä¸­å’Œå€~ä¸­å’Œ060å€", keywords: ["ä¸­å’Œ00", "ä¸­å’Œ01", "ä¸­å’Œ02", "ä¸­å’Œ03", "ä¸­å’Œ04", "ä¸­å’Œ05", "ä¸­å’Œ060"] },
      { name: "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€", keywords: ["ä¸­å’Œ06", "ä¸­å’Œ07", "ä¸­å’Œ08", "ä¸­å’Œ09", "ä¸­å’Œ1", "é–‹è’"] },
      { name: "ç²¾æ˜", keywords: ["ç²¾æ˜"] },
      { name: "é¦¬ä¾†è¥¿äº", keywords: ["é¦¬ä¾†è¥¿äº", "Malaysia"] },
      { name: "å°å°¼", keywords: ["å°å°¼", "Indonesia"] },
      { name: "è¶Šå— æ¾³æ´² å­ŸåŠ æ‹‰ åŠ æ‹¿å¤§", keywords: ["è¶Šå—", "æ¾³æ´²", "å­ŸåŠ æ‹‰", "åŠ æ‹¿å¤§"] }
    ];

    window.onload = loadData;

    async function loadData() {
      try {
        const res = await fetch(`${GAS_URL}?action=getList`);
        allData = await res.json();
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('search-absent-btn').classList.remove('hidden');
        showMainAreas();
      } catch (err) {
        document.getElementById('loader').innerText = "é€£ç·šå¤±æ•—ã€‚";
      }
    }

    function getParentGroupName(rawArea) {
      if (!rawArea) return "å…¶ä»–";
      if (rawArea.includes("ä¸­å’Œ")) {
        const numMatch = rawArea.match(/\d+/);
        if (numMatch) {
          const num = parseInt(numMatch[0]);
          if (num >= 1 && num <= 60) return "ä¸­å’Œå€~ä¸­å’Œ060å€";
          if (num >= 61) return "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€";
        }
        if (rawArea.includes("é–‹è’")) return "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€";
        return "ä¸­å’Œå€~ä¸­å’Œ060å€";
      }
      for (const group of AREA_GROUPS) {
        if (group.keywords.some(k => rawArea.includes(k))) return group.name;
      }
      return "å…¶ä»–";
    }

    function showMainAreas() {
      const areaGrid = document.getElementById('area-grid');
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const mainActions = document.getElementById('main-actions');
      const title = document.getElementById('title');

      title.innerText = "ğŸ“‹ è«‹é¸æ“‡å¤§åˆ†é¡";
      areaGrid.innerHTML = '';

      const displayGroups = AREA_GROUPS.map(g => g.name);
      if (allData.some(item => getParentGroupName(item.area) === "å…¶ä»–")) displayGroups.push("å…¶ä»–");

      displayGroups.forEach(groupName => {
        const count = allData.filter(item => getParentGroupName(item.area) === groupName).length;
        if (count > 0) {
          const btn = document.createElement('button');
          btn.className = 'area-btn';
          btn.innerHTML = `<span>${groupName}</span><small>(${count}äºº)</small>`;
          btn.onclick = () => showSubAreas(groupName);
          areaGrid.appendChild(btn);
        }
      });

      mainActions.classList.remove('hidden');
      areaGrid.classList.remove('hidden');
      subGrid.classList.add('hidden');
      nameList.classList.add('hidden');
      backBtn.classList.add('hidden');
    }

    function showSubAreas(parentName) {
      const areaGrid = document.getElementById('area-grid');
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const mainActions = document.getElementById('main-actions');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“‚ ${parentName}`;
      subGrid.innerHTML = '';
      mainActions.classList.add('hidden');

      const membersInParent = allData.filter(item => getParentGroupName(item.area) === parentName);
      const subAreas = [...new Set(membersInParent.map(item => item.area))].sort();

      subAreas.forEach(subName => {
        const count = membersInParent.filter(item => item.area === subName).length;
        const btn = document.createElement('button');
        btn.className = 'area-btn sub-area-btn';
        btn.innerHTML = `<span>${subName || "æœªåˆ†é¡"}</span><small>(${count}äºº)</small>`;
        btn.onclick = () => showNamesByFinalArea(subName, parentName);
        subGrid.appendChild(btn);
      });

      areaGrid.classList.add('hidden');
      subGrid.classList.remove('hidden');
      nameList.classList.add('hidden');
      backBtn.classList.remove('hidden');
      backBtn.onclick = showMainAreas;
    }

    function showNamesByFinalArea(finalArea, parentName) {
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“ ${finalArea || "æœªåˆ†é¡"}`;
      renderList(allData.filter(item => item.area === finalArea));

      subGrid.classList.add('hidden');
      nameList.classList.remove('hidden');
      backBtn.onclick = () => showSubAreas(parentName);
    }

    async function loadAndShowAbsentList() {
      const loader = document.getElementById('loader');
      loader.classList.remove('hidden');
      loader.innerText = "æ­£åœ¨è®€å–ç¼ºå¸­åå–®...";

      try {
        const res = await fetch(`${GAS_URL}?action=getAbsentList`);
        const absentData = await res.json();
        
        document.getElementById('title').innerText = "ğŸ“„ ä»Šæ—¥ç¼ºå¸­åå–®";
        renderAbsentList(absentData);

        document.getElementById('main-actions').classList.add('hidden');
        document.getElementById('area-grid').classList.add('hidden');
        document.getElementById('name-list').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        document.getElementById('back-btn').onclick = showMainAreas;
      } catch (e) {
        alert("è®€å–ç¼ºå¸­åå–®å¤±æ•—");
      } finally {
        loader.classList.add('hidden');
      }
    }

    function renderAbsentList(items) {
      const nameList = document.getElementById('name-list');
      nameList.innerHTML = '';
      if (items.length === 0) {
        nameList.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">âœ¨ ç›®å‰ç„¡ç¼ºå¸­äººå“¡</div>';
        return;
      }
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'absent-row';
        div.innerHTML = `
          <div class="absent-name">${item.name}</div>
          <div class="absent-detail-line">
            <span><span class="absent-label">æ€§åˆ¥</span><span class="absent-val">${item.gender || 'ç„¡'}</span></span>
            <span><span class="absent-label">åº§è™Ÿ</span><span class="absent-val">${item.seatNum || 'ç„¡'}</span></span>
          </div>
          <div class="absent-detail-line">
            <span><span class="absent-label">å€åŸŸ</span><span class="absent-val">${item.area || 'ç„¡'}</span></span>
            <span><span class="absent-label">åŸå› </span><span class="absent-val reason-text">${item.reason || 'æœªè¨»è¨˜'}</span></span>
          </div>
        `;
        nameList.appendChild(div);
      });
    }

    function renderList(items) {
      const nameList = document.getElementById('name-list');
      nameList.innerHTML = '';
      if (items.length === 0) {
        nameList.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">ç›®å‰ç„¡åå–®æ•¸æ“š</div>';
        return;
      }
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
          <div class="info">
            <span class="name-text">${item.name}</span>
            <span class="sub-text">${item.area} | åº§è™Ÿ: ${item.seatNum}</span>
          </div>
        `;
        const btnGroup = document.createElement('div');
        btnGroup.className = 'btn-group';
        
        const b1 = document.createElement('button'); 
        b1.className = 'btn-present'; 
        b1.innerText = 'å‡ºå¸­';
        b1.onclick = () => submit(b1, item, 'å‡ºå¸­');
        
        const b2 = document.createElement('button'); 
        b2.className = 'btn-leave'; 
        b2.innerText = 'è«‹å‡';
        b2.onclick = () => openLeaveModal(b2, item);
        
        btnGroup.appendChild(b1); 
        btnGroup.appendChild(b2);
        div.appendChild(btnGroup);
        nameList.appendChild(div);
      });
    }

    async function submit(btn, item, status, reason = "") {
      const originalText = btn.innerText;
      btn.disabled = true; 
      btn.innerText = "...";
      
      const params = new URLSearchParams({
        action: 'update',
        memberId: item.memberId, 
        name: item.name, 
        gender: item.gender,
        seatNum: item.seatNum, 
        area: item.area, 
        status: status, 
        reason: reason
      });

      try {
        const res = await fetch(`${GAS_URL}?${params.toString()}`);
        const data = await res.json();
        if(data.success) {
          btn.innerText = "å·²é€å‡º";
          btn.style.backgroundColor = "#999";
        } else {
          alert(data.message);
          btn.innerText = originalText;
        }
      } catch (err) { 
        alert("å‚³é€å¤±æ•—"); 
        btn.innerText = originalText;
      } finally {
        btn.disabled = false;
      }
    }

    function openLeaveModal(btn, item) {
      currentTargetItem = item;
      currentTargetBtn = btn;
      document.getElementById('modal-title-name').innerText = `ç‚º ${item.name} ç™»è¨˜è«‹å‡`;
      document.getElementById('leave-modal').classList.remove('hidden');
      document.getElementById('leave-reason').value = "ç—…å‡"; // é è¨­å€¼
      document.getElementById('other-reason').value = "";
      document.getElementById('other-reason').classList.add('hidden');
      
      document.getElementById('confirm-leave-btn').onclick = () => {
        const selectValue = document.getElementById('leave-reason').value;
        const otherValue = document.getElementById('other-reason').value;
        const finalReason = selectValue === "å…¶ä»–" ? otherValue : selectValue;
        
        if (selectValue === "å…¶ä»–" && !otherValue.trim()) {
            alert("è«‹è¼¸å…¥è«‹å‡åŸå› ");
            return;
        }
        
        submit(currentTargetBtn, currentTargetItem, 'è«‹å‡', finalReason);
        closeLeaveModal();
      };
    }

    function toggleOtherInput() {
      const select = document.getElementById('leave-reason');
      const otherInput = document.getElementById('other-reason');
      if (select.value === "å…¶ä»–") {
        otherInput.classList.remove('hidden');
        otherInput.focus();
      } else {
        otherInput.classList.add('hidden');
      }
    }

    function closeLeaveModal() {
      document.getElementById('leave-modal').classList.add('hidden');
    }
  </script>
</body>
</html>
