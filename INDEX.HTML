<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»åç³»çµ± - è«‹å‡åŠŸèƒ½ç‰ˆ</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background-color: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h3 { text-align: center; color: #444; margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .area-btn { background-color: #2196F3; color: white; border: none; padding: 20px; border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    .area-btn:hover { background-color: #1976D2; }
    .row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 15px 0; }
    .info { display: flex; flex-direction: column; }
    .name-text { font-size: 1.1em; font-weight: bold; }
    .sub-text { font-size: 0.85em; color: #666; }
    .btn-group { display: flex; gap: 8px; }
    button { border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
    .btn-present { background-color: #4caf50; color: white; }
    .btn-leave { background-color: #ff9800; color: white; }
    .back-btn { background-color: #757575; color: white; margin-bottom: 15px; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
    .hidden { display: none; }
    #loader { text-align: center; color: #666; padding: 20px; }
    .error-box { color: #d32f2f; background-color: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; display: none; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h3 id="title">ğŸ“‹ é»åç³»çµ± - è«‹é¸æ“‡å€åŸŸ</h3>
    <div id="error-display" class="error-box"></div>
    <button id="back-btn" class="back-btn hidden" onclick="showAreas()">â† è¿”å›å€åŸŸé¸æ“‡</button>
    <div id="loader">è®€å–åå†Šä¸­...</div>
    <div id="area-grid" class="grid hidden"></div>
    <div id="name-list" class="hidden"></div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxNFakNmcRc37HVkTyl3qmX4ovQ4REekrYTnHI7jbxW6LWO2uEoPaqP8Ok57lLtPT6J/exec";
    
    let allData = []; 

    window.onload = () => {
      loadData();
    };

    async function loadData() {
      const loader = document.getElementById('loader');
      const errorDisplay = document.getElementById('error-display');
      try {
        const response = await fetch(`${GAS_URL}?action=getList`);
        if (!response.ok) throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
        const data = await response.json();
        allData = data;
        loader.classList.add('hidden');
        errorDisplay.style.display = 'none';
        showAreas();
      } catch (err) {
        loader.style.display = 'none';
        errorDisplay.style.display = 'block';
        errorDisplay.innerHTML = `<strong>âŒ é€£ç·šå¤±æ•—</strong><br>è«‹ç¢ºèª GAS éƒ¨ç½²æ¬Šé™è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚`;
        console.error(err);
      }
    }

    function showAreas() {
      const areaGrid = document.getElementById('area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');
      title.innerText = "ğŸ“‹ é»åç³»çµ± - è«‹é¸æ“‡å€åŸŸ";
      areaGrid.innerHTML = '';
      if (!allData || allData.length === 0) {
        document.getElementById('loader').innerText = "åå†Šç„¡è³‡æ–™ã€‚";
        document.getElementById('loader').classList.remove('hidden');
        return;
      }
      const areas = [...new Set(allData.map(item => item.area))];
      areas.forEach(area => {
        const btn = document.createElement('button');
        btn.className = 'area-btn';
        btn.innerText = area || "æœªåˆ†é¡";
        btn.onclick = () => showNamesByArea(area);
        areaGrid.appendChild(btn);
      });
      areaGrid.classList.remove('hidden');
      nameList.classList.add('hidden');
      backBtn.classList.add('hidden');
    }

    function showNamesByArea(area) {
      const areaGrid = document.getElementById('area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');
      title.innerText = `ğŸ“ ${area || "æœªåˆ†é¡"}`;
      nameList.innerHTML = '';
      const filtered = allData.filter(item => item.area === area);
      filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
          <div class="info">
            <span class="name-text">${item.name}</span>
            <span class="sub-text">ID: ${item.memberId} | åº§è™Ÿ: ${item.seatNum}</span>
          </div>
          <div class="btn-group">
            <button class="btn-present" onclick="submit(this, ${JSON.stringify(item).replace(/"/g, '&quot;')}, 'å‡ºå¸­')">å‡ºå¸­</button>
            <button class="btn-leave" onclick="handleLeave(this, ${JSON.stringify(item).replace(/"/g, '&quot;')})">è«‹å‡</button>
          </div>
        `;
        nameList.appendChild(div);
      });
      areaGrid.classList.add('hidden');
      nameList.classList.remove('hidden');
      backBtn.classList.remove('hidden');
    }

    function handleLeave(btn, item) {
      const reason = prompt(`è«‹è¼¸å…¥ ${item.name} çš„è«‹å‡åŸå› ï¼š`);
      if (reason === null) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
      if (reason.trim() === "") {
        alert("è«‹è¼¸å…¥è«‹å‡åŸå› ï¼");
        return;
      }
      submit(btn, item, 'è«‹å‡', reason);
    }

    async function submit(btn, item, status, reason = "") {
      const originalText = btn.innerText;
      btn.disabled = true;
      btn.innerText = "å‚³é€ä¸­...";
      const params = new URLSearchParams({
        action: 'update',
        memberId: item.memberId,
        name: item.name,
        gender: item.gender,
        seatNum: item.seatNum,
        area: item.area,
        status: status,
        reason: reason
      });
      try {
        const response = await fetch(`${GAS_URL}?${params.toString()}`);
        const data = await response.json();
        alert(data.message);
      } catch (err) {
        alert("ç°½åˆ°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®šã€‚");
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }
  </script>
</body>
</html>
