<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å´‡æ­£ç­æœŸé»åç³»çµ± - çµ±åˆç‰ˆä»‹é¢</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background-color: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h3 { text-align: center; color: #444; margin-bottom: 20px; }
    
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .area-btn { 
      background-color: #2196F3; color: white; border: none; padding: 18px; 
      border-radius: 10px; font-size: 1.05em; cursor: pointer; font-weight: bold; 
      transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;
    }
    .area-btn:hover { background-color: #1976D2; transform: translateY(-2px); }
    .area-btn::after { content: 'â†’'; opacity: 0.7; }
    
    .class-btn { background-color: #4caf50; margin-bottom: 10px; }
    .class-btn:hover { background-color: #388e3c; }

    .sub-area-btn { background-color: #607D8B; }

    .row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 15px 0; }
    .info { display: flex; flex-direction: column; }
    .name-text { font-size: 1.1em; font-weight: bold; }
    .sub-text { font-size: 0.85em; color: #666; }
    
    .btn-group { display: flex; gap: 8px; }
    button { border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
    .btn-present { background-color: #4caf50; color: white; }
    .btn-leave { background-color: #ff9800; color: white; }
    
    .back-btn { background-color: #757575; color: white; margin-bottom: 15px; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
    .hidden { display: none !important; }
    
    #loader { text-align: center; color: #666; padding: 20px; font-size: 0.9em; }

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; 
      z-index: 9999; backdrop-filter: blur(2px);
    }
    .modal-card {
      background: white; padding: 24px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-card h4 { margin: 0 0 8px 0; color: #333; }
    .modal-card select, .modal-card input {
      width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; font-size: 1.1em; box-sizing: border-box;
    }
    .modal-actions { display: flex; gap: 12px; }
    .modal-actions button { flex: 1; padding: 12px; }
    .btn-cancel { background: #f0f0f0; color: #444; }
    .btn-confirm { background: #ff9800; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h3 id="title">ğŸ“ å´‡æ­£é»åç³»çµ±</h3>
    
    <!-- ç­ç´šé¸æ“‡é¦–é  -->
    <div id="class-select-grid" class="grid">
      <p id="class-hint" style="text-align:center; color:#666;">æ­£åœ¨è®€å–ç­ç´šæ¸…å–®...</p>
    </div>

    <div id="main-content" class="hidden">
      <button id="back-btn" class="back-btn hidden">â† è¿”å›</button>
      <div id="loader" class="hidden">è¼‰å…¥ä¸­...</div>
      <div id="area-grid" class="grid hidden"></div>
      <div id="sub-area-grid" class="grid hidden"></div>
      <div id="name-list" class="hidden"></div>
    </div>
  </div>

  <!-- è«‹å‡ Modal -->
  <div id="leave-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <h4 id="modal-title-name">è«‹å‡ç™»è¨˜</h4>
      <p>è«‹é¸æ“‡åŸå› ï¼š</p>
      <select id="leave-reason" onchange="toggleOtherInput()">
        <option value="ç—…å‡">ç—…å‡</option>
        <option value="äº‹å‡">äº‹å‡</option>
        <option value="å…¬å‡">å…¬å‡</option>
        <option value="æ™šåˆ°">æ™šåˆ°</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <input type="text" id="other-reason" class="hidden" placeholder="è«‹è¼¸å…¥è«‹å‡åŸå› ...">
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeLeaveModal()">å–æ¶ˆ</button>
        <button class="btn-confirm" id="confirm-leave-btn">ç¢ºèªæäº¤</button>
      </div>
    </div>
  </div>

  <script>
    // è«‹ç¢ºèªæ­¤ URL èˆ‡æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€ä¸€è‡´
    const GAS_URL = "https://script.google.com/macros/s/AKfycby2Eaaw-MCs-zfX5b5W5k_y20rfRZJVW4zMtZIqHMjNPFSkBUb9ZTrNuwSQmrG0iw2U/exec";
    let allData = []; 
    let selectedClass = ""; 
    let currentTargetItem = null;
    let currentTargetBtn = null;

    const AREA_GROUPS = [
      { name: "ä¸­å’Œå€~ä¸­å’Œ060å€", keywords: ["ä¸­å’Œ00", "ä¸­å’Œ01", "ä¸­å’Œ02", "ä¸­å’Œ03", "ä¸­å’Œ04", "ä¸­å’Œ05", "ä¸­å’Œ060"] },
      { name: "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€", keywords: ["ä¸­å’Œ06", "ä¸­å’Œ07", "ä¸­andå’Œ08", "ä¸­å’Œ09", "ä¸­å’Œ1", "é–‹è’"] },
      { name: "ç²¾æ˜", keywords: ["ç²¾æ˜"] },
      { name: "é¦¬ä¾†è¥¿äº", keywords: ["é¦¬ä¾†è¥¿äº", "Malaysia"] },
      { name: "å°å°¼", keywords: ["å°å°¼", "Indonesia"] },
      { name: "è¶Šå— æ¾³æ´² å­ŸåŠ æ‹‰ åŠ æ‹¿å¤§", keywords: ["è¶Šå—", "æ¾³æ´²", "å­ŸåŠ æ‹‰", "åŠ æ‹¿å¤§"] }
    ];

    window.onload = async function() {
      try {
        // ä½¿ç”¨ init æŒ‡ä»¤å–å¾—ç­ç´š
        const res = await fetch(`${GAS_URL}?action=init`);
        const result = await res.json();
        const grid = document.getElementById('class-select-grid');
        const hint = document.getElementById('class-hint');
        
        if (result.status !== "success" || !result.data.classes || result.data.classes.length === 0) {
          hint.innerText = "ç›®å‰æ²’æœ‰ä»»ä½•ç­ç´šè³‡æ–™ã€‚";
          return;
        }

        hint.innerText = "è«‹é¸æ“‡é»åç­ç´šï¼š";
        result.data.classes.forEach(cls => {
          const btn = document.createElement('button');
          btn.className = 'area-btn class-btn';
          btn.innerHTML = `<span>${cls}</span>`;
          btn.onclick = () => selectClass(cls);
          grid.appendChild(btn);
        });
      } catch (e) {
        document.getElementById('class-hint').innerText = "ç„¡æ³•è¼‰å…¥ç­ç´šæ¸…å–®ï¼Œè«‹æª¢æŸ¥ GAS ç¶²å€èˆ‡æ¬Šé™ã€‚";
      }
    };

    async function selectClass(className) {
      selectedClass = className;
      document.getElementById('class-select-grid').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('loader').classList.remove('hidden');
      await loadData();
    }

    async function loadData() {
      try {
        // ä½¿ç”¨ getMemberList æŒ‡ä»¤
        const res = await fetch(`${GAS_URL}?action=getMemberList&className=${encodeURIComponent(selectedClass)}`);
        const result = await res.json();
        
        if (result.status === "success") {
            allData = result.data;
            document.getElementById('loader').classList.add('hidden');
            showMainAreas();
        } else {
            document.getElementById('loader').innerText = "è®€å–å¤±æ•—ï¼š" + result.message;
        }
      } catch (err) {
        document.getElementById('loader').innerText = "é€£ç·šå¤±æ•—ã€‚";
      }
    }

    // å€åŸŸåˆ¤æ–·é‚è¼¯ (ç¶­æŒä¸è®Š)
    function getParentGroupName(rawArea) {
      if (!rawArea) return "å…¶ä»–";
      const areaStr = String(rawArea);
      if (areaStr.includes("ä¸­å’Œ")) {
        const numMatch = areaStr.match(/\d+/);
        if (numMatch) {
          const num = parseInt(numMatch[0]);
          if (num >= 1 && num <= 60) return "ä¸­å’Œå€~ä¸­å’Œ060å€";
          if (num >= 61) return "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€";
        }
        if (areaStr.includes("é–‹è’")) return "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€";
        return "ä¸­å’Œå€~ä¸­å’Œ060å€";
      }
      for (const group of AREA_GROUPS) {
        if (group.keywords.some(k => areaStr.includes(k))) return group.name;
      }
      return "å…¶ä»–";
    }

    function showMainAreas() {
      const areaGrid = document.getElementById('area-grid');
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“‹ ${selectedClass} - åˆ†é¡`;
      areaGrid.innerHTML = '';

      const displayGroups = AREA_GROUPS.map(g => g.name);
      if (allData.some(item => getParentGroupName(item.area) === "å…¶ä»–")) displayGroups.push("å…¶ä»–");

      displayGroups.forEach(groupName => {
        const count = allData.filter(item => getParentGroupName(item.area) === groupName).length;
        if (count > 0) {
          const btn = document.createElement('button');
          btn.className = 'area-btn';
          btn.innerHTML = `<span>${groupName}</span><small>(${count}äºº)</small>`;
          btn.onclick = () => showSubAreas(groupName);
          areaGrid.appendChild(btn);
        }
      });

      areaGrid.classList.remove('hidden');
      subGrid.classList.add('hidden');
      nameList.classList.add('hidden');
      
      backBtn.classList.remove('hidden');
      backBtn.onclick = () => {
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('class-select-grid').classList.remove('hidden');
        document.getElementById('title').innerText = "ğŸ“ å´‡æ­£é»åç³»çµ±";
        allData = [];
      };
    }

    function showSubAreas(parentName) {
      const areaGrid = document.getElementById('area-grid');
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“‚ ${parentName}`;
      subGrid.innerHTML = '';

      const membersInParent = allData.filter(item => getParentGroupName(item.area) === parentName);
      const subAreas = [...new Set(membersInParent.map(item => item.area))].sort();

      subAreas.forEach(subName => {
        const count = membersInParent.filter(item => item.area === subName).length;
        const btn = document.createElement('button');
        btn.className = 'area-btn sub-area-btn';
        btn.innerHTML = `<span>${subName || "æœªåˆ†é¡"}</span><small>(${count}äºº)</small>`;
        btn.onclick = () => showNamesByFinalArea(subName, parentName);
        subGrid.appendChild(btn);
      });

      areaGrid.classList.add('hidden');
      subGrid.classList.remove('hidden');
      nameList.classList.add('hidden');
      backBtn.onclick = showMainAreas;
    }

    function showNamesByFinalArea(finalArea, parentName) {
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“ ${finalArea || "æœªåˆ†é¡"}`;
      renderList(allData.filter(item => item.area === finalArea));

      subGrid.classList.add('hidden');
      nameList.classList.remove('hidden');
      backBtn.onclick = () => showSubAreas(parentName);
    }

    function renderList(items) {
      const nameList = document.getElementById('name-list');
      nameList.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
          <div class="info">
            <span class="name-text">${item.name}</span>
            <span class="sub-text">${item.area} | åº§è™Ÿ: ${item.seatNum}</span>
          </div>
        `;
        const btnGroup = document.createElement('div');
        btnGroup.className = 'btn-group';
        
        const b1 = document.createElement('button'); 
        b1.className = 'btn-present'; 
        b1.innerText = 'å‡ºå¸­';
        b1.onclick = () => submitData(b1, item, 'å‡ºå¸­');
        
        const b2 = document.createElement('button'); 
        b2.className = 'btn-leave'; 
        b2.innerText = 'è«‹å‡';
        b2.onclick = () => openLeaveModal(b2, item);
        
        btnGroup.appendChild(b1); 
        btnGroup.appendChild(b2);
        div.appendChild(btnGroup);
        nameList.appendChild(div);
      });
    }

    // ä½¿ç”¨ POST æ–¹å¼å‚³é€è‡³æ–°å¾Œç«¯
    async function submitData(btn, item, status, reason = "") {
      const originalText = btn.innerText;
      btn.disabled = true; 
      btn.innerText = "...";
      
      const payload = {
        action: 'updateStatus',
        className: selectedClass,
        memberId: item.memberId,
        name: item.name,
        gender: item.gender,
        seatNum: item.seatNum,
        area: item.area,
        status: status,
        reason: reason
      };

      try {
        const res = await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if(result.status === "success") {
          btn.innerText = "å·²é€å‡º";
          btn.style.backgroundColor = "#999";
        } else {
          alert(result.message);
          btn.innerText = originalText;
          btn.disabled = false;
        }
      } catch (err) { 
        alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); 
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    function openLeaveModal(btn, item) {
      currentTargetItem = item;
      currentTargetBtn = btn;
      document.getElementById('modal-title-name').innerText = `ç‚º ${item.name} ç™»è¨˜è«‹å‡`;
      document.getElementById('leave-modal').classList.remove('hidden');
      document.getElementById('confirm-leave-btn').onclick = () => {
        const selectValue = document.getElementById('leave-reason').value;
        const otherValue = document.getElementById('other-reason').value;
        const finalReason = selectValue === "å…¶ä»–" ? otherValue : selectValue;
        if (selectValue === "å…¶ä»–" && !otherValue.trim()) { alert("è«‹è¼¸å…¥åŸå› "); return; }
        submitData(currentTargetBtn, currentTargetItem, 'è«‹å‡', finalReason);
        closeLeaveModal();
      };
    }

    function toggleOtherInput() {
      const select = document.getElementById('leave-reason');
      const otherInput = document.getElementById('other-reason');
      if (select.value === "å…¶ä»–") { otherInput.classList.remove('hidden'); otherInput.focus(); }
      else { otherInput.classList.add('hidden'); }
    }

    function closeLeaveModal() {
      document.getElementById('leave-modal').classList.add('hidden');
    }
  </script>
</body>
</html>
