<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å´‡æ­£ç­æœŸé»åç³»çµ±</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background-color: #f5f5f5; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h3 { text-align: center; color: #444; margin-bottom: 20px; }
    
    /* å€åŸŸæŒ‰éˆ•æ¨£å¼ */
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .area-btn { 
      background-color: #2196F3; color: white; border: none; padding: 18px; 
      border-radius: 10px; font-size: 1.05em; cursor: pointer; font-weight: bold; 
      transition: all 0.2s; text-align: left; display: flex; justify-content: space-between; align-items: center;
    }
    .area-btn:hover { background-color: #1976D2; transform: translateY(-2px); }
    .area-btn::after { content: 'â†’'; opacity: 0.7; }
    
    /* å°å€åŸŸæŒ‰éˆ•æ¨£å¼ (é¡è‰²ç¨æ·¡) */
    .sub-area-btn { background-color: #607D8B; }
    .sub-area-btn:hover { background-color: #455A64; }

    /* åå–®é¡¯ç¤º */
    .row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; padding: 15px 0; }
    .info { display: flex; flex-direction: column; }
    .name-text { font-size: 1.1em; font-weight: bold; }
    .sub-text { font-size: 0.85em; color: #666; }
    
    .btn-group { display: flex; gap: 8px; }
    button { border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
    .btn-present { background-color: #4caf50; color: white; }
    .btn-leave { background-color: #ff9800; color: white; }
    
    .back-btn { background-color: #757575; color: white; margin-bottom: 15px; width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
    .hidden { display: none !important; }
    
    #loader { text-align: center; color: #666; padding: 20px; }
    .error-box { color: #d32f2f; background-color: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; display: none; word-break: break-all; }

    /* Modal æ¨£å¼ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; 
      z-index: 9999; backdrop-filter: blur(2px);
    }
    .modal-card {
      background: white; padding: 24px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .modal-card h4 { margin: 0 0 8px 0; color: #333; }
    .modal-card select {
      width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd; font-size: 1.1em;
    }
    .modal-actions { display: flex; gap: 12px; }
    .modal-actions button { flex: 1; padding: 12px; }
    .btn-cancel { background: #f0f0f0; color: #444; }
    .btn-confirm { background: #ff9800; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h3 id="title">ğŸ“‹ é»åç³»çµ±</h3>
    <div id="error-display" class="error-box"></div>
    <button id="back-btn" class="back-btn hidden">â† è¿”å›</button>
    <div id="loader">æ­£åœ¨è®€å–é›²ç«¯åå†Š...</div>
    <div id="area-grid" class="grid hidden"></div>
    <div id="sub-area-grid" class="grid hidden"></div>
    <div id="name-list" class="hidden"></div>
  </div>

  <!-- è«‹å‡å½ˆçª— -->
  <div id="leave-modal" class="modal-overlay hidden">
    <div class="modal-card">
      <h4 id="modal-title-name">è«‹å‡ç™»è¨˜</h4>
      <p>è«‹é¸æ“‡åŸå› ï¼š</p>
      <select id="leave-reason">
        <option value="ç—…å‡">ç—…å‡</option>
        <option value="äº‹å‡">äº‹å‡</option>
        <option value="å…¬å‡">å…¬å‡</option>
        <option value="æ™šåˆ°">æ™šåˆ°</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeLeaveModal()">å–æ¶ˆ</button>
        <button class="btn-confirm" id="confirm-leave-btn">ç¢ºèªæäº¤</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxNFakNmcRc37HVkTyl3qmX4ovQ4REekrYTnHI7jbxW6LWO2uEoPaqP8Ok57lLtPT6J/exec";
    
    let allData = []; 
    let currentTargetItem = null; 
    let currentTargetBtn = null;
    let currentView = 'main'; // main, sub, list

    // å®šç¾©å€åŸŸåˆ†é¡è¦å‰‡
    const AREA_GROUPS = [
      { name: "ä¸­å’Œå€~ä¸­å’Œ060å€", keywords: ["ä¸­å’Œ", "ä¸­å’Œ00", "ä¸­å’Œ01", "ä¸­å’Œ02", "ä¸­ scavenger 03", "ä¸­å’Œ04", "ä¸­å’Œ05", "ä¸­å’Œ060"] },
      { name: "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€", keywords: ["ä¸­å’Œ06", "ä¸­å’Œ07", "ä¸­å’Œ08", "ä¸­å’Œ09", "ä¸­å’Œ1", "é–‹è’"] },
      { name: "ç²¾æ˜", keywords: ["ç²¾æ˜"] },
      { name: "é¦¬ä¾†è¥¿äº", keywords: ["é¦¬ä¾†è¥¿äº", "Malaysia"] },
      { name: "å°å°¼", keywords: ["å°å°¼", "Indonesia"] },
      { name: "è¶Šå— æ¾³æ´² å­ŸåŠ æ‹‰ åŠ æ‹¿å¤§", keywords: ["è¶Šå—", "æ¾³æ´²", "å­ŸåŠ æ‹‰", "åŠ æ‹¿å¤§"] }
    ];

    window.onload = loadData;

    async function loadData() {
      try {
        const response = await fetch(`${GAS_URL}?action=getList`);
        allData = await response.json();
        document.getElementById('loader').classList.add('hidden');
        showMainAreas();
      } catch (err) {
        document.getElementById('loader').classList.add('hidden');
        const errorDisplay = document.getElementById('error-display');
        errorDisplay.style.display = 'block';
        errorDisplay.innerHTML = "ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS éƒ¨ç½²æ¬Šé™ã€‚";
      }
    }

    // å°‡å…·é«”å€åŸŸåˆ†é…åˆ°è‡ªå®šç¾©å¤§åˆ†é¡
    function getParentGroupName(rawArea) {
      if (!rawArea) return "å…¶ä»–";
      if (rawArea.includes("ä¸­å’Œ")) {
        const numMatch = rawArea.match(/\d+/);
        if (numMatch) {
          const num = parseInt(numMatch[0]);
          if (num >= 1 && num <= 60) return "ä¸­å’Œå€~ä¸­å’Œ060å€";
          if (num >= 61) return "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€";
        }
        if (rawArea.includes("é–‹è’")) return "ä¸­å’Œ061å€~ä¸­å’Œé–‹è’å€";
        return "ä¸­å’Œå€~ä¸­å’Œ060å€";
      }
      for (const group of AREA_GROUPS) {
        if (group.keywords.some(k => rawArea.includes(k))) return group.name;
      }
      return "å…¶ä»–";
    }

    // [ç¬¬ä¸€å±¤] é¡¯ç¤ºå¤§åˆ†é¡
    function showMainAreas() {
      currentView = 'main';
      const areaGrid = document.getElementById('area-grid');
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = "ğŸ“‹ è«‹é¸æ“‡å¤§åˆ†é¡";
      areaGrid.innerHTML = '';

      const displayGroups = AREA_GROUPS.map(g => g.name);
      if (allData.some(item => getParentGroupName(item.area) === "å…¶ä»–")) displayGroups.push("å…¶ä»–");

      displayGroups.forEach(groupName => {
        const count = allData.filter(item => getParentGroupName(item.area) === groupName).length;
        if (count > 0) {
          const btn = document.createElement('button');
          btn.className = 'area-btn';
          btn.innerHTML = `<span>${groupName}</span><small style="font-size:0.7em; font-weight:normal;">(${count}äºº)</small>`;
          btn.onclick = () => showSubAreas(groupName);
          areaGrid.appendChild(btn);
        }
      });

      areaGrid.classList.remove('hidden');
      subGrid.classList.add('hidden');
      nameList.classList.add('hidden');
      backBtn.classList.add('hidden');
    }

    // [ç¬¬äºŒå±¤] é¡¯ç¤ºå¤§åˆ†é¡ä¸‹çš„æ‰€æœ‰å°å€åŸŸ
    function showSubAreas(parentName) {
      currentView = 'sub';
      const areaGrid = document.getElementById('area-grid');
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“‚ ${parentName}`;
      subGrid.innerHTML = '';

      // éæ¿¾å‡ºå±¬æ–¼æ­¤å¤§åˆ†é¡çš„æ‰€æœ‰æˆå“¡ï¼Œä¸¦æå–ä»–å€‘å…·é«”çš„å€åŸŸ
      const membersInParent = allData.filter(item => getParentGroupName(item.area) === parentName);
      const subAreas = [...new Set(membersInParent.map(item => item.area))].sort();

      subAreas.forEach(subName => {
        const count = membersInParent.filter(item => item.area === subName).length;
        const btn = document.createElement('button');
        btn.className = 'area-btn sub-area-btn';
        btn.innerHTML = `<span>${subName || "æœªåˆ†é¡"}</span><small style="font-size:0.7em; font-weight:normal;">(${count}äºº)</small>`;
        btn.onclick = () => showNamesByFinalArea(subName, parentName);
        subGrid.appendChild(btn);
      });

      areaGrid.classList.add('hidden');
      subGrid.classList.remove('hidden');
      nameList.classList.add('hidden');
      backBtn.classList.remove('hidden');
      backBtn.onclick = showMainAreas;
    }

    // [ç¬¬ä¸‰å±¤] é¡¯ç¤ºå…·é«”å€åŸŸçš„äººå“¡åå–®
    function showNamesByFinalArea(finalArea, parentName) {
      currentView = 'list';
      const subGrid = document.getElementById('sub-area-grid');
      const nameList = document.getElementById('name-list');
      const backBtn = document.getElementById('back-btn');
      const title = document.getElementById('title');

      title.innerText = `ğŸ“ ${finalArea || "æœªåˆ†é¡"}`;
      nameList.innerHTML = '';

      const filtered = allData.filter(item => item.area === finalArea);

      filtered.forEach(item => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = `
          <div class="info">
            <span class="name-text">${item.name}</span>
            <span class="sub-text">åº§è™Ÿ: ${item.seatNum} | ID: ${item.memberId}</span>
          </div>
        `;
        
        const btnGroup = document.createElement('div');
        btnGroup.className = 'btn-group';
        
        const btnPresent = document.createElement('button');
        btnPresent.className = 'btn-present';
        btnPresent.innerText = 'å‡ºå¸­';
        btnPresent.onclick = () => submit(btnPresent, item, 'å‡ºå¸­');

        const btnLeave = document.createElement('button');
        btnLeave.className = 'btn-leave';
        btnLeave.innerText = 'è«‹å‡';
        btnLeave.onclick = () => openLeaveModal(btnLeave, item);

        btnGroup.appendChild(btnPresent);
        btnGroup.appendChild(btnLeave);
        div.appendChild(btnGroup);
        nameList.appendChild(div);
      });

      subGrid.classList.add('hidden');
      nameList.classList.remove('hidden');
      backBtn.onclick = () => showSubAreas(parentName);
    }

    function openLeaveModal(btn, item) {
      currentTargetItem = item;
      currentTargetBtn = btn;
      document.getElementById('modal-title-name').innerText = `ç‚º ${item.name} ç™»è¨˜è«‹å‡`;
      document.getElementById('leave-modal').classList.remove('hidden');
      document.getElementById('confirm-leave-btn').onclick = () => {
        const reason = document.getElementById('leave-reason').value;
        submit(currentTargetBtn, currentTargetItem, 'è«‹å‡', reason);
        closeLeaveModal();
      };
    }

    function closeLeaveModal() {
      document.getElementById('leave-modal').classList.add('hidden');
    }

    async function submit(btn, item, status, reason = "") {
      const originalText = btn.innerText;
      btn.disabled = true;
      btn.innerText = "...";

      const params = new URLSearchParams({
        action: 'update',
        memberId: item.memberId,
        name: item.name,
        gender: item.gender,
        seatNum: item.seatNum,
        area: item.area,
        status: status,
        reason: reason
      });

      try {
        const response = await fetch(`${GAS_URL}?${params.toString()}`);
        const data = await response.json();
        alert(data.message);
      } catch (err) {
        alert("å‚³é€å¤±æ•—");
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }
  </script>
</body>
</html>
